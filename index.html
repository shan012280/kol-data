<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KOL å°ˆæ¥­æ•¸æ“šç®¡ç†é¢æ¿</title>
    <style>
        :root { 
            --primary: #f97316; 
            --bg: #fffaf5; 
            --text-main: #431407; 
            --header-bg: #fdba74; 
        }

        body { font-family: "PingFang TC", "Microsoft JhengHei", sans-serif; background: var(--bg); padding: 15px; margin: 0; color: var(--text-main); }
        .card { background: white; border-radius: 16px; box-shadow: 0 4px 20px rgba(251, 146, 60, 0.1); padding: 18px; max-width: 1200px; margin: auto; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #ffedd5; padding-bottom: 15px; flex-wrap: wrap; gap: 10px; }
        
        table { width: 100%; border-collapse: collapse; }
        th { padding: 14px 4px; text-align: left; font-size: 13px; font-weight: 600; color: #7c2d12; letter-spacing: 0.5px; cursor: pointer; user-select: none; }
        .th-basic { background-color: #ffedd5; }
        .th-data { background-color: #fed7aa; }
        .th-flow { background-color: #fdba74; }
        .th-action { background-color: #ffedd5; text-align: center; }

        td { padding: 8px 4px; border-bottom: 1px solid #fff7ed; }
        input, select { width: 100%; height: 34px; border: 1px solid #fed7aa; padding: 0 8px; border-radius: 8px; font-size: 14px; box-sizing: border-box; outline: none; background: #fff; transition: all 0.2s ease; }

        /* --- è‰²å¡Šæ¨£å¼ (é è¨­èˆ‡å±•é–‹) --- */
        .p-gray { background-color: #f1f5f9 !important; color: #64748b !important; }
        .p-blue { background-color: #e0f2fe !important; color: #0369a1 !important; font-weight: bold; }
        .p-green { background-color: #dcfce7 !important; color: #15803d !important; font-weight: bold; }
        .p-red { background-color: #fee2e2 !important; color: #b91c1c !important; font-weight: bold; }

        .a-none { background-color: #ffffff !important; color: #94a3b8 !important; }
        .a-orange { background-color: #fff7ed !important; color: #c2410c !important; font-weight: bold; }
        .a-purple { background-color: #f5f3ff !important; color: #6d28d9 !important; font-weight: bold; }
        .a-teal { background-color: #f0fdfa !important; color: #0f766e !important; font-weight: bold; }
        .a-final { background-color: #f97316 !important; color: #ffffff !important; font-weight: bold; }

        .btn-add { background: #f97316; color: white; border: none; padding: 10px 20px; border-radius: 10px; cursor: pointer; font-weight: 600; }
        .btn-export { background: #fb923c; color: white; border: none; padding: 10px 20px; border-radius: 10px; cursor: pointer; font-weight: 600; }
        
        .data-price { text-align: right; font-weight: 700; color: #9a3412; }
        .jump-btn { text-decoration: none; background: #fff7ed; color: #ea580c; padding: 0 8px; border-radius: 6px; font-size: 10px; display: none; }
        .jump-btn.active { display: inline-block; }

        @media screen and (max-width: 768px) {
            table, thead, tbody, th, td, tr { display: block; }
            thead tr { position: absolute; top: -9999px; left: -9999px; }
            tr { border: 1px solid #fed7aa; border-radius: 12px; margin-bottom: 20px; padding: 10px; background: #fff; }
            td { border: none; position: relative; padding-left: 100px; margin-bottom: 8px; min-height: 40px; display: flex; align-items: center; }
            td:before { position: absolute; left: 10px; width: 85px; font-weight: bold; color: #7c2d12; font-size: 13px; content: attr(data-label); }
        }
    </style>
</head>
<body>

<div class="card">
    <div class="header">
        <h2 style="margin:0; color:#431407; font-size: 20px;">KOL æ•¸æ“šç®¡ç†ç³»çµ±</h2>
        <div style="display:flex; gap:12px;">
            <button class="btn-export" onclick="exportToExcel()">ğŸ“¥ åŒ¯å‡º Excel</button>
            <button class="btn-add" onclick="addRow()">+ æ–°å¢ KOL é …ç›®</button>
        </div>
    </div>

    <table id="kolTable">
        <thead>
            <tr>
                <th style="width: 10%;" class="th-basic">å§“å</th>
                <th style="width: 15%;" class="th-basic">IG é€£çµ</th>
                <th style="width: 15%;" class="th-basic">FB é€£çµ</th>
                <th style="width: 12%;" class="th-data" onclick="cycleSort()">å ±åƒ¹ (TWD) <span id="sortIcon">ğŸ”ƒ</span></th>
                <th style="width: 13%;" class="th-flow">åˆä½œé€²åº¦</th>
                <th style="width: 15%;" class="th-flow">ç°½å‘ˆç‹€æ…‹</th>
                <th style="width: 15%;" class="th-flow">é è¨ˆåŒ¯æ¬¾æ—¥</th>
                <th style="width: 5%;" class="th-action"></th>
            </tr>
        </thead>
        <tbody id="tableBody"></tbody>
    </table>
</div>

<script>
    let sortState = 0; 
    let originalData = []; // ç”¨æ–¼æ¢å¾©åŸå§‹é †åº

    // é é¢é–‹å•Ÿæ™‚è®€å–å­˜æª”
    window.onload = function() {
        const saved = localStorage.getItem('kol_data_v2');
        if (saved) {
            const data = JSON.parse(saved);
            data.forEach(item => addRow(item));
        } else {
            for(let i=0; i<3; i++) addRow();
        }
    };

    // æ ¸å¿ƒï¼šå°‡æ‰€æœ‰æ¬„ä½å­˜å…¥ localStorage
    function saveToLocal() {
        const rows = Array.from(document.querySelectorAll("#tableBody tr"));
        const data = rows.map(tr => {
            const inputs = tr.querySelectorAll("input, select");
            return {
                name: inputs[0].value,
                ig: inputs[1].value,
                fb: inputs[2].value,
                price: inputs[3].value,
                process: inputs[4].value,
                admin: inputs[5].value,
                date: inputs[6].value
            };
        });
        localStorage.setItem('kol_data_v2', JSON.stringify(data));
    }

    function addRow(saved = null) {
        const tbody = document.getElementById("tableBody");
        const tr = document.createElement("tr");
        const m = new Date().getMonth() + 1;
        const nextM = m === 12 ? 1 : m + 1;

        tr.innerHTML = `
            <td data-label="å§“å"><input type="text" value="${saved?.name || ''}" oninput="saveToLocal()" placeholder="å§“å..."></td>
            <td data-label="IG"><div style="display:flex; gap:4px; width:100%;"><input type="text" value="${saved?.ig || ''}" oninput="checkUrl(this); saveToLocal()" placeholder="ig..."><a href="${saved?.ig || '#'}" target="_blank" class="jump-btn ${saved?.ig ? 'active' : ''}">ğŸ”—</a></div></td>
            <td data-label="FB"><div style="display:flex; gap:4px; width:100%;"><input type="text" value="${saved?.fb || ''}" oninput="checkUrl(this); saveToLocal()" placeholder="fb..."><a href="${saved?.fb || '#'}" target="_blank" class="jump-btn ${saved?.fb ? 'active' : ''}">ğŸ”—</a></div></td>
            <td data-label="å ±åƒ¹"><input type="text" class="data-price" value="${saved?.price || ''}" onblur="formatCurrency(this); saveToLocal()" onfocus="unformatCurrency(this)" placeholder="0"></td>
            <td data-label="é€²åº¦">
                <select class="data-process" onchange="updateProcessColor(this); saveToLocal()">
                    <option value="å¾…è¯ç¹«" style="background-color: #f1f5f9;" ${saved?.process === 'å¾…è¯ç¹«' ? 'selected' : ''}>å¾…è¯ç¹«</option>
                    <option value="æ´½è«‡ä¸­" style="background-color: #e0f2fe;" ${saved?.process === 'æ´½è«‡ä¸­' ? 'selected' : ''}>æ´½è«‡ä¸­</option>
                    <option value="å·²ç°½ç´„" style="background-color: #dcfce7;" ${saved?.process === 'å·²ç°½ç´„' ? 'selected' : ''}>å·²ç°½ç´„</option>
                    <option value="ä¸è€ƒæ…®" style="background-color: #fee2e2;" ${saved?.process === 'ä¸è€ƒæ…®' ? 'selected' : ''}>ä¸è€ƒæ…®</option>
                </select>
            </td>
            <td data-label="ç°½å‘ˆ">
                <select class="data-admin" onchange="updateAdminColor(this); saveToLocal()">
                    <option value="å°šæœªé€ç°½" style="background-color: #ffffff;" ${saved?.admin === 'å°šæœªé€ç°½' ? 'selected' : ''}>å°šæœªé€ç°½</option>
                    <option value="å·²é€ç°½è‡³å‰¯ç¸½" style="background-color: #fff7ed;" ${saved?.admin === 'å·²é€ç°½è‡³å‰¯ç¸½' ? 'selected' : ''}>ğŸ“ å·²é€ç°½å‰¯ç¸½</option>
                    <option value="å‰¯ç¸½å·²æ ¸å‡†" style="background-color: #f5f3ff;" ${saved?.admin === 'å‰¯ç¸½å·²æ ¸å‡†' ? 'selected' : ''}>ğŸ¢ å‰¯ç¸½å·²æ ¸å‡†</option>
                    <option value="å·²é€äº¤æœƒè¨ˆ" style="background-color: #f0fdfa;" ${saved?.admin === 'å·²é€äº¤æœƒè¨ˆ' ? 'selected' : ''}>ğŸ’° å·²é€äº¤æœƒè¨ˆ</option>
                    <option value="æœƒè¨ˆå·²æ’¥æ¬¾" style="background-color: #f97316;" ${saved?.admin === 'æœƒè¨ˆå·²æ’¥æ¬¾' ? 'selected' : ''}>âœ… æœƒè¨ˆå·²æ’¥æ¬¾</option>
                </select>
            </td>
            <td data-label="åŒ¯æ¬¾">
                <select onchange="saveToLocal()">
                    <option value="">é¸æ“‡æ—¥æœŸ</option>
                    <option value="${m}/10" ${saved?.date === m+'/10' ? 'selected' : ''}>${m}/10</option>
                    <option value="${m}/25" ${saved?.date === m+'/25' ? 'selected' : ''}>${m}/25</option>
                    <option value="${nextM}/10" ${saved?.date === nextM+'/10' ? 'selected' : ''}>${nextM}/10</option>
                    <option value="${nextM}/25" ${saved?.date === nextM+'/25' ? 'selected' : ''}>${nextM}/25</option>
                </select>
            </td>
            <td style="text-align: center;"><button style="color:#fed7aa; border:none; background:none; cursor:pointer; font-size:24px;" onclick="removeRow(this)">&times;</button></td>
        `;
        tbody.appendChild(tr);
        updateProcessColor(tr.querySelector('.data-process'));
        updateAdminColor(tr.querySelector('.data-admin'));
        if (!saved) saveToLocal();
    }

    function updateProcessColor(s) {
        s.classList.remove('p-gray', 'p-blue', 'p-green', 'p-red');
        const v = s.value;
        if(v === "å¾…è¯ç¹«") s.classList.add('p-gray');
        else if(v === "æ´½è«‡ä¸­") s.classList.add('p-blue');
        else if(v === "å·²ç°½ç´„") s.classList.add('p-green');
        else if(v === "ä¸è€ƒæ…®") s.classList.add('p-red');
    }

    function updateAdminColor(s) {
        s.classList.remove('a-none', 'a-orange', 'a-purple', 'a-teal', 'a-final');
        const v = s.value;
        if(v.includes("å·²é€ç°½")) s.classList.add('a-orange');
        else if(v.includes("å‰¯ç¸½å·²æ ¸å‡†")) s.classList.add('a-purple');
        else if(v.includes("é€äº¤æœƒè¨ˆ")) s.classList.add('a-teal');
        else if(v.includes("æœƒè¨ˆå·²æ’¥æ¬¾")) s.classList.add('a-final');
        else s.classList.add('a-none');
    }

    function cycleSort() {
        const tbody = document.getElementById("tableBody");
        const rows = Array.from(tbody.querySelectorAll("tr"));
        const icon = document.getElementById("sortIcon");
        sortState = (sortState + 1) % 3;
        
        if (sortState === 0) {
            icon.innerText = "ğŸ”ƒ";
            tbody.innerHTML = "";
            const saved = JSON.parse(localStorage.getItem('kol_data_v2') || "[]");
            saved.forEach(item => addRow(item));
            return;
        }
        rows.sort((a, b) => {
            let valA = parseInt(a.querySelector(".data-price").value.replace(/,/g, "")) || 0;
            let valB = parseInt(b.querySelector(".data-price").value.replace(/,/g, "")) || 0;
            return sortState === 1 ? valB - valA : valA - valB;
        });
        icon.innerText = sortState === 1 ? "â¬‡ï¸" : "â¬†ï¸";
        rows.forEach(row => tbody.appendChild(row));
    }

    function formatCurrency(i) { let v = i.value.replace(/\D/g, ""); if (v !== "") i.value = Number(v).toLocaleString('en-US'); }
    function unformatCurrency(i) { i.value = i.value.replace(/,/g, ""); }
    function checkUrl(i) { 
        const v = i.value.trim(); const b = i.nextElementSibling;
        if (v.startsWith('http') || v.includes('.com')) { b.href = v.startsWith('http') ? v : 'https://' + v; b.classList.add('active'); } 
        else b.classList.remove('active'); 
    }
    function removeRow(btn) { if(confirm("ç¢ºå®šåˆªé™¤å—ï¼Ÿ")) { btn.parentElement.parentElement.remove(); saveToLocal(); } }

    function exportToExcel() {
        let csvContent = "\ufeffå§“å,IG,FB,å ±åƒ¹,é€²åº¦,ç‹€æ…‹,åŒ¯æ¬¾æ—¥\n";
        document.querySelectorAll("#tableBody tr").forEach(row => {
            const inputs = row.querySelectorAll("input, select");
            let rowData = Array.from(inputs).map(i => i.value.replace(/,/g, ""));
            csvContent += rowData.join(",") + "\n";
        });
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "KOL_Tracker.csv";
        link.click();
    }
</script>

</body>
</html>
